---
- name: Create milvus-etcd, minio, pulsar, network
  hosts: swarm-manager
  become: yes
  become_user: root
  tags: docker
  tasks:
  - name: Create milvus network
    docker_network: 
      name: "{{network}}"
      driver: "bridge"
      attachable: yes
      # ipam_config:
      # - subnet: "{{subnet}}"
      #   gateway: "{{gateway}}"
      #   iprange: "{{iprange}}"

  - name: milvus-etcd
    docker_container: 
      name: milvus-etcd
      image: quay.io/coreos/etcd:v3.5.0
      command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
      healthcheck:
        test: ["CMD", "wget", "-q", "--tries=1", "--spider", "http://localhost:2381/health"]
        interval: 30s
        timeout: 20s
        retries: 3
      env:
        ETCD_AUTO_COMPACTION_MODE: revision
        ETCD_AUTO_COMPACTION_RETENTION: "1000"
        ETCD_QUOTA_BACKEND_BYTES: "4294967296"
      network_mode: "{{ network }}"
      ports:
        - 2379

  - name: milvus-minio
    docker_container: 
      name: milvus-minio
      image: minio/minio:RELEASE.2022-03-17T06-34-49Z
      env:
        MINIO_ACCESS_KEY: minioadmin
        MINIO_SECRET_KEY: minioadmin
      command: "minio server /minio_data"
      healthcheck:
        test: ["CMD", "curl", "-f", "http://127.0.0.1:9000/minio/health/live"]
        interval: 30s
        timeout: 20s
        retries: 3
      network_mode: "{{ network }}"
      ports:
        - 9000

  - name: milvus-pulsar
    docker_container: 
      name: milvus-pulsar
      image: apachepulsar/pulsar:2.8.2
      env:
        # bin/apply-config-from-env.py script will modify the configuration file based on the environment variables
        # nettyMaxFrameSizeBytes must be calculated from maxMessageSize + 10240 (padding)
        nettyMaxFrameSizeBytes: "104867840" # this is 104857600 + 10240 (padding)
        defaultRetentionTimeInMinutes: "10080"
        defaultRetentionSizeInMB: "8192"
        # maxMessageSize is missing from standalone.conf, must use PULSAR_PREFIX_ to get it configured
        PULSAR_PREFIX_maxMessageSize: "104857600"
        PULSAR_GC: -XX:+UseG1GC        
      command: "bin/pulsar standalone --no-functions-worker --no-stream-storage" #/bin/bash -c bin/apply-config-from-env.py conf/standalone.conf &&
      network_mode: "{{ network }}"
      ports:
        - "6650"

  - name: milvus-proxy
    docker_container: 
      name: milvus-proxy
      image: milvusdb/milvus:v2.0.1
      command: "milvus run proxy"
      env:
        ETCD_ENDPOINTS: "{{ETCD_ENDPOINTS}}"
        MINIO_ADDRESS: "{{MINIO_ADDRESS}}"
        PULSAR_ADDRESS: "{{PULSAR_ADDRESS}}"
      network_mode: "{{ network }}"
      ports:
        - "19530"
        - "9091" 

  - name: milvus-querycoord
    docker_container: 
      name: milvus-querycoord
      image: milvusdb/milvus:v2.0.1
      command: "milvus run querycoord"
      env:
        ETCD_ENDPOINTS: "{{ETCD_ENDPOINTS}}"
        MINIO_ADDRESS: "{{MINIO_ADDRESS}}"
        PULSAR_ADDRESS: "{{PULSAR_ADDRESS}}"
        QUERY_COORD_ADDRESS: "{{QUERY_COORD_ADDRESS}}"
      network_mode: "{{ network }}"
      ports:
        - "19531"
        - "9091"  

# - name: Create all kinds of milvus coord & node
#   hosts: swarm-worker-01
#   become: yes
#   become_user: root
#   tags: docker
#   tasks:
  - name: milvus-datacoord
    docker_container: 
      name: milvus-datacoord
      image: milvusdb/milvus:v2.0.1
      command: ["milvus", "run", "datacoord"]
      env:
        ETCD_ENDPOINTS: "{{ETCD_ENDPOINTS}}"
        MINIO_ADDRESS: "{{MINIO_ADDRESS}}"
        PULSAR_ADDRESS: "{{PULSAR_ADDRESS}}"
        DATA_COORD_ADDRESS: "{{DATA_COORD_ADDRESS}}"
      network_mode: "{{ network }}"
      ports:
        - "13333"
        - "9091"   
 
  - name: milvus-rootcoord
    docker_container: 
      name: milvus-rootcoord
      image: milvusdb/milvus:v2.0.1
      command: ["milvus", "run", "rootcoord"]
      env:
        ETCD_ENDPOINTS: "{{ETCD_ENDPOINTS}}"
        MINIO_ADDRESS: "{{MINIO_ADDRESS}}"
        PULSAR_ADDRESS: "{{PULSAR_ADDRESS}}"
        QUERY_COORD_ADDRESS: "{{QUERY_COORD_ADDRESS}}"
      network_mode: "{{ network }}"
      ports:
        - "53100"
        - "9091"
    
  - name: milvus-indexcoord
    docker_container: 
      name: milvus-indexcoord
      image: milvusdb/milvus:v2.0.1
      command: ["milvus", "run", "indexcoord"]
      env:
        ETCD_ENDPOINTS: "{{ETCD_ENDPOINTS}}"
        MINIO_ADDRESS: "{{MINIO_ADDRESS}}"
        PULSAR_ADDRESS: "{{PULSAR_ADDRESS}}"
        INDEX_COORD_ADDRESS: "{{INDEX_COORD_ADDRESS}}"
      network_mode: "{{ network }}"
      ports:
        - "31000"
        - "9091"  
    
  - name: milvus-querynode
    docker_container: 
      name: milvus-querynode
      image: milvusdb/milvus:v2.0.1
      command: "milvus run querynode"
      env:
        ETCD_ENDPOINTS: "{{ETCD_ENDPOINTS}}"
        MINIO_ADDRESS: "{{MINIO_ADDRESS}}"
        PULSAR_ADDRESS: "{{PULSAR_ADDRESS}}"      
      network_mode: "{{ network }}"
      ports:
        - "21123"
        - "9091"

  - name: milvus-datanode
    docker_container: 
      name: milvus-datanode
      image: milvusdb/milvus:v2.0.1
      command: "milvus run datanode"
      env:
        ETCD_ENDPOINTS: "{{ETCD_ENDPOINTS}}"
        MINIO_ADDRESS: "{{MINIO_ADDRESS}}"
        PULSAR_ADDRESS: "{{PULSAR_ADDRESS}}"   
      network_mode: "{{ network }}"
      ports:
        - "21124"
        - "9091"

  - name: milvus-indexnode
    docker_container: 
      name: milvus-indexnode
      image: milvusdb/milvus:v2.0.1
      command: "milvus run indexnode"
      env:
        ETCD_ENDPOINTS: "{{ETCD_ENDPOINTS}}"
        MINIO_ADDRESS: "{{MINIO_ADDRESS}}"
        PULSAR_ADDRESS: "{{PULSAR_ADDRESS}}"
        INDEX_COORD_ADDRESS: "{{INDEX_COORD_ADDRESS}}"
      network_mode: "{{ network }}"
      ports:
        - "21121"
        - "9091"
